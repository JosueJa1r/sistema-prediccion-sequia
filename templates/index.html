<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Predicción de Sequía - México</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .state-selector {
            margin: 20px 0;
            text-align: left;
        }
        
        .state-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold; 
            color: #e0e0e0; /* Color de texto claro */
        }
        
        .state-dropdown {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px; 
            color: #333; /* Texto oscuro para el dropdown */
            background-color: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }
        
        .state-dropdown:focus {
            outline: none;
            border-color: #9F2241;
        }
        
        .state-dropdown:hover {
            border-color: #9F2241;
        }
        
        .analysis-section {
            margin-top: 30px;
            padding: 20px;
            background-color: rgba(40, 50, 65, 0.6); /* Fondo semitransparente */
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-radius: 8px;
            border-left: 4px solid #9F2241;
        }
        
        .analysis-section h3 {
            color: #ffffff; /* Texto blanco para el título */
        }
        
        .method-card {
            background: rgba(50, 60, 75, 0.7); /* Fondo semitransparente */
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .method-title {
            font-weight: bold;
            color: #ffffff; /* Texto blanco */
            margin-bottom: 8px;
        }
        
        .prediction-value {
            font-size: 18px;
            font-weight: bold;
            color: #ffc107; /* Color de valor resaltado */
        }
        
        .state-info {
            background-color: #f8f0e6;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid #BC955C;
            color: #333; /* Color de texto oscuro para contraste */
        }

        .dashboard-toggle {
            background-color: #BC955C;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
            transition: background-color 0.3s ease;
        }
        
        .dashboard-toggle:hover {
            background-color: #A0824F;
        }

        .dashboard-section {
            margin-top: 30px;
            padding: 20px;
            background-color: rgba(40, 50, 65, 0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-radius: 8px;
            border-left: 4px solid #BC955C;
            display: none; /* Oculto por defecto */
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .dashboard-card {
            background: rgba(50, 60, 75, 0.7);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .dashboard-card h4 {
            margin-top: 0;
            color: #ffffff;
            border-bottom: 2px solid #9F2241;
            padding-bottom: 10px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 15px;
        }

        .chart-description {
            background-color: rgba(30, 40, 55, 0.7);
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #9F2241;
            font-size: 14px;
            line-height: 1.6;
            color: #d0d0d0;
        }
        
        .chart-description strong {
            color: #9F2241;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sistema de Predicción de Sequía - Chihuahua</h1>
            <p>Análisis inteligente de riesgo de sequía para los municipios de Chihuahua, basado en datos meteorológicos históricos y modelos matemáticos.</p>
        </div>

        <!-- Formulario con selector de municipios -->
        <div class="form-section">
            <form id="precipitationForm">
                <div class="form-group">
                    <label><strong>Análisis Automático de Sequía por Municipio</strong></label>
                    <p>Seleccione un municipio de Chihuahua para obtener un análisis automático basado en los datos meteorológicos más recientes.</p>
                    
                    <div class="state-selector">
                        <label for="municipioSelect">Seleccionar Municipio:</label>
                        <select id="municipioSelect" class="state-dropdown">
                            <option value="Ahumada">Ahumada</option>
                            <option value="Aldama">Aldama</option>
                            <option value="Allende">Allende</option>
                            <option value="Aquiles Serdán">Aquiles Serdán</option>
                            <option value="Ascensión">Ascensión</option>
                            <option value="Bachíniva">Bachíniva</option>
                            <option value="Balleza">Balleza</option>
                            <option value="Batopilas">Batopilas</option>
                            <option value="Bocoyna">Bocoyna</option>
                            <option value="Buenaventura">Buenaventura</option>
                            <option value="Camargo">Camargo</option>
                            <option value="Carichí">Carichí</option>
                            <option value="Casas Grandes">Casas Grandes</option>
                            <option value="Chihuahua">Chihuahua</option>
                            <option value="Chínipas">Chínipas</option>
                            <option value="Coronado">Coronado</option>
                            <option value="Coyame del Sotol">Coyame del Sotol</option>
                            <option value="La Cruz">La Cruz</option>
                            <option value="Cuauhtémoc">Cuauhtémoc</option>
                            <option value="Cusihuiriachi">Cusihuiriachi</option>
                            <option value="Delicias">Delicias</option>
                            <option value="Dr. Belisario Domínguez">Dr. Belisario Domínguez</option>
                            <option value="Durango">Durango</option>
                            <option value="Galeana">Galeana</option>
                            <option value="Gómez Farías">Gómez Farías</option>
                            <option value="Gran Morelos">Gran Morelos</option>
                            <option value="Guachochi">Guachochi</option>
                            <option value="Guadalupe">Guadalupe</option>
                            <option value="Guadalupe y Calvo">Guadalupe y Calvo</option>
                            <option value="Guazapares">Guazapares</option>
                            <option value="Guerrero">Guerrero</option>
                            <option value="Hidalgo del Parral">Hidalgo del Parral</option>
                            <option value="Huejotitán">Huejotitán</option>
                            <option value="Ignacio Zaragoza">Ignacio Zaragoza</option>
                            <option value="Janos">Janos</option>
                            <option value="Jalisco">Jalisco</option>
                            <option value="Jiménez">Jiménez</option>
                            <option value="Juárez">Juárez</option>
                            <option value="Julimes">Julimes</option>
                            <option value="López">López</option>
                            <option value="Madera">Madera</option>
                            <option value="Maguarichi">Maguarichi</option>
                            <option value="Manuel Benavides">Manuel Benavides</option>
                            <option value="Matachí">Matachí</option>
                            <option value="Matamoros">Matamoros</option>
                            <option value="Meoqui">Meoqui</option>
                            <option value="Morelos">Morelos</option>
                            <option value="Moris">Moris</option>
                            <option value="Namiquipa">Namiquipa</option>
                            <option value="Nonoava">Nonoava</option>
                            <option value="Nuevo Casas Grandes">Nuevo Casas Grandes</option>
                            <option value="Ocampo">Ocampo</option>
                            <option value="Ojinaga">Ojinaga</option>
                            <option value="Praxedis G. Guerrero">Praxedis G. Guerrero</option>
                            <option value="Riva Palacio">Riva Palacio</option>
                            <option value="Rosales">Rosales</option>
                            <option value="Rosario">Rosario</option>
                            <option value="San Francisco de Borja">San Francisco de Borja</option>
                            <option value="San Francisco de Conchos">San Francisco de Conchos</option>
                            <option value="San Francisco del Oro">San Francisco del Oro</option>
                            <option value="Santa Bárbara">Santa Bárbara</option>
                            <option value="Santa Isabel">Santa Isabel</option>
                            <option value="Satevó">Satevó</option>
                            <option value="Saucillo">Saucillo</option>
                            <option value="Temósachic">Temósachic</option>
                            <option value="El Tule">El Tule</option>
                            <option value="Urique">Urique</option>
                            <option value="Uruachi">Uruachi</option>
                            <option value="Valle de Zaragoza">Valle de Zaragoza</option>
                        </select>
                    </div>
                    
                    <p>El sistema utiliza datos históricos de precipitación de los últimos 90 días para calcular el riesgo de sequía usando métodos matemáticos avanzados.</p>
                    <button type="button" class="btn" id="autoAnalysisBtn">Analizar Riesgo de Sequía</button>
                </div>
            </form>
        </div>

        <!-- Indicador de carga -->
        <div class="loader" id="loader"></div>

        <!-- Sección de resultados -->
        <div class="output-container" id="outputContainer">
            <div id="results" class="results">
                <!-- Los resultados se mostrarán aquí dinámicamente -->
            </div>
            
            <!-- Sección de análisis detallado -->
            <div id="analysisDetails" class="analysis-section" style="display: none;">
                <h3>Análisis Detallado de Métodos</h3>
                <div id="methodsAnalysis">
                    <!-- Análisis de métodos se mostrará aquí -->
                </div>

                <!-- Botón para mostrar dashboard -->
                <button type="button" class="dashboard-toggle" id="dashboardToggle" style="display: none;">Ver Análisis Avanzado</button>
            </div>
        </div>

        <!-- Sección del Dashboard Avanzado -->
        <div id="dashboardSection" class="dashboard-section">
            <h3>Dashboard de Análisis Avanzado</h3>
            <div class="dashboard-grid">
                <!-- Gráfico de Líneas: Precipitación vs. Tiempo -->
                <div class="dashboard-card">
                    <h4>Precipitación y Tendencia (Últimos 90 días)</h4>
                    <p class="chart-description">La línea azul muestra la lluvia diaria. La línea roja (tendencia) suaviza las variaciones para revelar si la situación mejora (sube) o empeora (baja).</p>
                    <div class="chart-container"><canvas id="lineChart"></canvas></div>
                </div>

                <!-- Gráfico de Dispersión: Lluvia vs. Temperatura -->
                <div class="dashboard-card">
                    <h4>Dispersión: Lluvia vs. Temperatura</h4>
                    <p class="chart-description">Cada punto representa un día. Puntos en la esquina inferior derecha (alta temperatura, poca lluvia) son indicadores clave de condiciones de sequía.</p>
                    <div class="chart-container"><canvas id="scatterChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Función para mostrar loader
        function showLoader() {
            document.getElementById('loader').style.display = 'block';
            document.getElementById('outputContainer').style.display = 'none';
        }

        // Función para ocultar loader
        function hideLoader() {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('outputContainer').style.display = 'flex';
        }

        // Función para mostrar resultados
        function displayResults(data) {
            const results = document.getElementById('results');
            const analysisDetails = document.getElementById('analysisDetails');
            const methodsAnalysis = document.getElementById('methodsAnalysis');
            
            // Limpiar animaciones previas y añadir la nueva
            results.classList.remove('fade-in');
            analysisDetails.classList.remove('fade-in');

            // Seleccionar icono basado en el nivel de riesgo
            let iconHtml = '';
            switch (data.className) {
                case 'risk-d0':
                    iconHtml = '<i class="fas fa-cloud-sun" style="margin-right: 10px;"></i>';
                    break;
                case 'risk-d1':
                    iconHtml = '<i class="fas fa-tint-slash" style="margin-right: 10px;"></i>';
                    break;
                case 'risk-d2':
                    iconHtml = '<i class="fas fa-exclamation-triangle" style="margin-right: 10px;"></i>';
                    break;
                case 'risk-d3':
                    iconHtml = '<i class="fas fa-fire" style="margin-right: 10px;"></i>';
                    break;
                case 'risk-d4':
                    iconHtml = '<i class="fas fa-skull-crossbones" style="margin-right: 10px;"></i>';
                    break;
                default:
                    iconHtml = '<i class="fas fa-question-circle" style="margin-right: 10px;"></i>';
            }

            // Mostrar resultados principales
                results.innerHTML = `
                <div class="state-info">
                    <strong>Municipio Analizado: ${data.municipio}</strong>
                </div>
                    <h3>${iconHtml}Nivel de Riesgo: ${data.nivel}</h3>
                    <p><strong>Probabilidad de Sequía:</strong> ${(data.riesgo * 100).toFixed(1)}%</p>
                    <small style="display: block; margin-top: -10px; margin-bottom: 15px; color: #2ecc71; font-style: italic;">Este porcentaje es un índice compuesto basado en la tendencia de precipitación.</small>
                    <p class="accion"><strong>Recomendación:</strong> ${data.accion}</p>
                `;
                
                // Aplicar clase de riesgo
                results.className = `results ${data.className}`;
                
            // Mostrar análisis detallado de métodos
            methodsAnalysis.innerHTML = `
                <div class="method-card">
                    <div class="method-title">Análisis de Tendencia (Cálculo Diferencial)</div>
                    <div class="prediction-value">${(data.riesgoTendencia * 100).toFixed(1)}%</div>
                    <p><strong>Su trabajo:</strong> Mide la velocidad y dirección del cambio en la precipitación reciente. Nos dice si la situación está mejorando o empeorando rápidamente.</p>
                </div>
                
                <div class="method-card">
                    <div class="method-title">Predicción Estadística (Regresión Lineal)</div>
                    <div class="prediction-value">${(data.prediccionEstadistica * 100).toFixed(1)}%</div>
                    <p><strong>Su trabajo:</strong> Aprende de los patrones históricos. Compara la lluvia actual con la de años pasados para ver si se parece a un patrón de sequía ya conocido.</p>
                </div>
                
                <div class="method-card">
                    <div class="method-title">Modelo Algebraico (Mínimos Cuadrados)</div>
                    <div class="prediction-value">${(data.prediccionAlgebra * 100).toFixed(1)}%</div>
                    <p><strong>Su trabajo:</strong> Encuentra la "mejor línea" matemática que se ajusta a todos los datos históricos. Es un método robusto para confirmar la relación entre la falta de lluvia y el riesgo.</p>
                </div>
                
            `;
            
            // Mostrar contenedores
                results.style.display = 'block';
                // Forzar un reflow para que la animación se reinicie
                void results.offsetWidth; 
                results.classList.add('fade-in');

            analysisDetails.style.display = 'block';
                void analysisDetails.offsetWidth;
                analysisDetails.classList.add('fade-in');
        }
                
        // Función para mostrar errores
        function displayError(error) {
            const results = document.getElementById('results');
                results.innerHTML = `
                <h3>Error en el Análisis</h3>
                    <p>No se pudo obtener el análisis de riesgo. Por favor, intente nuevamente.</p>
                    <p><strong>Error:</strong> ${error.message}</p>
                `;
                results.className = 'results risk-high';
                results.classList.remove('fade-in');
                void results.offsetWidth;
                results.classList.add('fade-in');
                results.style.display = 'block';
        }

        let lineChart = null;
        let scatterChart = null;

        // Función para crear gráfico de líneas (Precipitación vs. Tiempo)
        function createLineChart(data) {
            const ctx = document.getElementById('lineChart').getContext('2d');
            if (lineChart) lineChart.destroy();

            // Calcular promedio móvil de 7 días para la tendencia
            const movingAverage = Array(6).fill(null); // Rellena los primeros 6 días con null
            for (let i = 6; i < data.length; i++) { // Empieza el cálculo desde el 7mo día (índice 6)
                const avg = data.slice(i - 6, i + 1).reduce((sum, item) => sum + item.precipitacion, 0) / 7;
                movingAverage.push(avg);
            }

            const labels = data.map(item => new Date(item.fecha).toLocaleDateString('es-MX', { month: 'short', day: 'numeric' }));

            lineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Precipitación Diaria (mm)',
                        data: data.map(item => item.precipitacion),
                        borderColor: 'rgba(54, 162, 235, 0.8)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        fill: false,
                        yAxisID: 'y'
                    }, {
                        label: 'Tendencia (Promedio 7 días)',
                        data: movingAverage,
                        borderColor: 'rgba(255, 99, 132, 0.8)',
                        fill: false,
                        tension: 0.4,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Precipitación (mm)', color: '#d0d0d0' },
                            ticks: { color: '#d0d0d0' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: { ticks: { color: '#d0d0d0' } }
                    },
                    plugins: { legend: { labels: { color: '#e0e0e0' } } }
                }
            });
        }

        // Función para crear gráfico de dispersión (Lluvia vs. Temperatura)
        function createScatterChart(data) {
            const ctx = document.getElementById('scatterChart').getContext('2d');
            if (scatterChart) scatterChart.destroy();

            scatterChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Días (Lluvia vs. Temp)',
                        data: data,
                        backgroundColor: 'rgba(255, 193, 7, 0.7)'
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Precipitación (mm)', color: '#d0d0d0' },
                            ticks: { color: '#d0d0d0' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            title: { display: true, text: 'Temperatura (°C)', color: '#d0d0d0' },
                            ticks: { color: '#d0d0d0' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: { legend: { labels: { color: '#e0e0e0' } } }
                }
            });
        }

        // Función para cargar datos del dashboard
        async function loadDashboardData(municipio) {
            try {
                const response = await fetch(`/api/dashboard/${encodeURIComponent(municipio)}`);
                if (!response.ok) throw new Error(`Error del servidor: ${response.status}`);
                
                const data = await response.json();
                if (data.error) throw new Error(data.message);

                createLineChart(data.datos_lineas);
                createScatterChart(data.datos_dispersion);

            } catch (error) {
                console.error('Error cargando dashboard:', error);
                alert('Error al cargar los datos del dashboard: ' + error.message);
            }
        }

        // Event listener para el botón del dashboard
        document.getElementById('dashboardToggle').addEventListener('click', function() {
            console.log("Botón de dashboard presionado.");
            const dashboardSection = document.getElementById('dashboardSection');
            const isHidden = dashboardSection.style.display === 'none' || dashboardSection.style.display === '';
            
            if (isHidden) {
                dashboardSection.style.display = 'block';
                loadDashboardData(currentMunicipio);
            } 
        });

        let currentMunicipio = 'Chihuahua';

        // Análisis automático
        document.getElementById('autoAnalysisBtn').addEventListener('click', async function() {
            showLoader();
            
            try {
                const municipioSeleccionado = document.getElementById('municipioSelect').value;
                currentMunicipio = municipioSeleccionado;
                console.log(`Iniciando análisis automático para: ${municipioSeleccionado}`);
                
                const response = await fetch(`/api/analizar?municipio=${encodeURIComponent(municipioSeleccionado)}`);
                
                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Datos recibidos:', data);
                
                if (data.error) {
                    throw new Error(data.message);
                }
                
                hideLoader();
                displayResults(data);
                
                // Mostrar el botón del dashboard y ocultar el dashboard
                document.getElementById('dashboardToggle').style.display = 'inline-block';
                this.textContent = 'Ver Análisis Avanzado'; // Restaurar texto del botón
                document.getElementById('dashboardSection').style.display = 'none';


            } catch (error) {
                console.error('Error en análisis:', error);
                hideLoader();
                displayError(error);
            }
        });
    </script>
</body>
</html>
