<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Predicción de Sequía - México</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .state-selector {
            margin: 20px 0;
            text-align: left;
        }
        
        .state-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold; 
            color: #e0e0e0; /* Color de texto claro */
        }
        
        .state-dropdown {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px; 
            color: #333; /* Texto oscuro para el dropdown */
            background-color: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }
        
        .state-dropdown:focus {
            outline: none;
            border-color: #9F2241;
        }
        
        .state-dropdown:hover {
            border-color: #9F2241;
        }
        
        .analysis-section {
            margin-top: 30px;
            padding: 20px;
            background-color: rgba(40, 50, 65, 0.6); /* Fondo semitransparente */
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-radius: 8px;
            border-left: 4px solid #9F2241;
        }
        
        .analysis-section h3 {
            color: #ffffff; /* Texto blanco para el título */
        }
        
        .method-card {
            background: rgba(50, 60, 75, 0.7); /* Fondo semitransparente */
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .method-title {
            font-weight: bold;
            color: #ffffff; /* Texto blanco */
            margin-bottom: 8px;
        }
        
        .prediction-value {
            font-size: 18px;
            font-weight: bold;
            color: #ffc107; /* Color de valor resaltado */
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: rgba(0, 0, 0, 0.25); /* Fondo oscuro semitransparente */
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
            border: 1px solid rgba(255, 255, 255, 0.1); /* Borde sutil */
        }
        
        .progress-fill {
            height: 100%;
            transition: width 0.5s ease-in-out; /* Transición más suave */
            border-radius: 10px;
            /* Animación de rayas diagonales */
            background-size: 40px 40px;
            background-image: linear-gradient(
                45deg, 
                rgba(255, 255, 255, 0.15) 25%, 
                transparent 25%, 
                transparent 50%, 
                rgba(255, 255, 255, 0.15) 50%, 
                rgba(255, 255, 255, 0.15) 75%, 
                transparent 75%, 
                transparent
            );
            animation: progress-bar-stripes 1s linear infinite;
        }
        
        .progress-low { background-color: #28a745; }
        .progress-medium { background-color: #ffc107; }
        .progress-high { background-color: #dc3545; }
        
        .state-info {
            background-color: #f8f0e6;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid #BC955C;
            color: #333; /* Color de texto oscuro para contraste */
        }
        
        .dashboard-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #BC955C; 
            background-color: rgba(40, 50, 65, 0.6); /* Fondo semitransparente */
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: none;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .dashboard-card {
            background: rgba(50, 60, 75, 0.7); /* Fondo semitransparente */
            padding: 20px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .dashboard-section h3 {
            color: #ffffff; /* Texto blanco */
        }
        
        .dashboard-card h4 {
            margin-top: 0;
            color: #ffffff; /* Texto blanco */
            border-bottom: 2px solid #9F2241;
            padding-bottom: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background-color: rgba(30, 40, 55, 0.7); /* Fondo semitransparente */
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-left: 4px solid #9F2241;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #9F2241;
        }
        
        .stat-label {
            font-size: 14px;
            color: #d0d0d0; /* Texto claro */
            margin-top: 5px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 15px 0;
        }
        
        .dashboard-toggle {
            background-color: #BC955C;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
            transition: background-color 0.3s ease;
        }
        
        .dashboard-toggle:hover {
            background-color: #A0824F;
        }
        
        .stats-description {
            background-color: rgba(188, 149, 92, 0.2); /* Fondo semitransparente */
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #BC955C;
            font-size: 14px;
            line-height: 1.6;
            color: #d0d0d0; /* Texto claro */
        }
        
        .stats-explanation {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #9F2241; 
            background-color: rgba(30, 40, 55, 0.7); /* Fondo semitransparente */
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stats-explanation h5 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #9F2241;
            font-size: 16px;
        }
        
        .stats-explanation ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .stats-explanation li {
            margin-bottom: 8px;
            font-size: 14px;
            line-height: 1.5; 
            color: #d0d0d0; /* Texto claro */
        }
        
        .stats-explanation strong {
            color: #9F2241;
        }

        @keyframes progress-bar-stripes {
            from { background-position: 40px 0; }
            to { background-position: 0 0; }
        }
        
        .chart-description {
            background-color: rgba(30, 40, 55, 0.7);
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #9F2241;
            font-size: 14px;
            line-height: 1.6;
            color: #d0d0d0;
        }
        
        .chart-description strong {
            color: #9F2241;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sistema de Predicción de Sequía</h1>
            <p>Análisis inteligente de riesgo de sequía para todos los estados de México basado en datos meteorológicos históricos y modelos matemáticos</p>
        </div>

        <!-- Formulario con selector de estados -->
        <div class="form-section">
            <form id="precipitationForm">
                <div class="form-group">
                    <label><strong>Análisis Automático de Sequía por Estado</strong></label>
                    <p>Seleccione un estado de México para obtener un análisis automático basado en los datos meteorológicos más recientes.</p>
                    
                    <div class="state-selector">
                        <label for="estadoSelect">Seleccionar Estado:</label>
                        <select id="estadoSelect" class="state-dropdown">
                            <option value="Chihuahua">Chihuahua</option>
                            <option value="Sonora">Sonora</option>
                            <option value="Coahuila">Coahuila</option>
                            <option value="Nuevo León">Nuevo León</option>
                            <option value="Tamaulipas">Tamaulipas</option>
                            <option value="Durango">Durango</option>
                            <option value="Zacatecas">Zacatecas</option>
                            <option value="San Luis Potosí">San Luis Potosí</option>
                            <option value="Aguascalientes">Aguascalientes</option>
                            <option value="Jalisco">Jalisco</option>
                            <option value="Guanajuato">Guanajuato</option>
                            <option value="Querétaro">Querétaro</option>
                            <option value="Hidalgo">Hidalgo</option>
                            <option value="México">México</option>
                            <option value="Puebla">Puebla</option>
                            <option value="Tlaxcala">Tlaxcala</option>
                            <option value="Morelos">Morelos</option>
                            <option value="Ciudad de México">Ciudad de México</option>
                            <option value="Veracruz">Veracruz</option>
                            <option value="Tabasco">Tabasco</option>
                            <option value="Campeche">Campeche</option>
                            <option value="Yucatán">Yucatán</option>
                            <option value="Quintana Roo">Quintana Roo</option>
                            <option value="Chiapas">Chiapas</option>
                            <option value="Oaxaca">Oaxaca</option>
                            <option value="Guerrero">Guerrero</option>
                            <option value="Michoacán">Michoacán</option>
                            <option value="Colima">Colima</option>
                            <option value="Nayarit">Nayarit</option>
                            <option value="Sinaloa">Sinaloa</option>
                            <option value="Baja California">Baja California</option>
                            <option value="Baja California Sur">Baja California Sur</option>
                        </select>
                    </div>
                    
                    <p>El sistema utiliza datos históricos de precipitación de los últimos 90 días para calcular el riesgo de sequía usando métodos matemáticos avanzados.</p>
                    <button type="button" class="btn" id="autoAnalysisBtn">Analizar Riesgo de Sequía</button>
                </div>
            </form>
        </div>

        <!-- Indicador de carga -->
        <div class="loader" id="loader"></div>

        <!-- Sección de resultados -->
        <div class="output-container" id="outputContainer">
            <div id="results" class="results">
                <!-- Los resultados se mostrarán aquí dinámicamente -->
            </div>
            
            <!-- Sección de análisis detallado -->
            <div id="analysisDetails" class="analysis-section" style="display: none;">
                <h3>Análisis Detallado de Métodos</h3>
                <div id="methodsAnalysis">
                    <!-- Análisis de métodos se mostrará aquí -->
                </div>
                
                <!-- Botón para mostrar dashboard -->
                <button class="dashboard-toggle" id="dashboardToggle">Ver Dashboard de Datos</button>
            </div>
            
            <!-- Sección del Dashboard -->
            <div id="dashboardSection" class="dashboard-section">
                <h3>Dashboard de Datos Meteorológicos</h3>
                <div class="dashboard-grid">
                    <!-- Estadísticas principales -->
                    <div class="dashboard-card">
                        <h4>Estadísticas Principales</h4>
                        <p class="stats-description">
                            Las siguientes métricas proporcionan un resumen cuantitativo de los patrones de precipitación 
                            observados en los últimos 90 días para el estado seleccionado. Estos datos son fundamentales 
                            para evaluar las condiciones hidrológicas y el riesgo de sequía.
                        </p>
                        <div class="stats-grid" id="statsGrid">
                            <!-- Las estadísticas se mostrarán aquí -->
                        </div>
                        <div class="stats-explanation">
                            <h5>Explicación de las Métricas:</h5>
                            <ul>
                                <li><strong>Total (mm):</strong> Suma acumulada de toda la precipitación registrada durante el período de 90 días.</li>
                                <li><strong>Promedio Diario:</strong> Cantidad promedio de precipitación por día, calculada dividiendo el total entre 90 días.</li>
                                <li><strong>Máximo Diario:</strong> El día con mayor cantidad de precipitación registrada en el período analizado.</li>
                                <li><strong>Días Sin Lluvia:</strong> Número total de días en los que no se registró precipitación alguna.</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Gráfico de precipitación diaria -->
                    <div class="dashboard-card">
                        <h4>Precipitación Diaria (Últimos 90 días)</h4>
                        <p class="chart-description">
                            <strong>¿Qué puedes ver aquí?</strong><br>
                            Este gráfico muestra la cantidad de lluvia registrada cada día durante los últimos 90 días. 
                            Las barras rojas representan los milímetros de precipitación diaria. 
                            <strong>Picos altos</strong> indican días lluviosos, mientras que 
                            <strong>barras bajas o ausentes</strong> sugieren períodos secos. 
                            Esta información es crucial para identificar patrones de sequía.
                        </p>
                        <div class="chart-container">
                            <canvas id="dailyChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Gráfico de precipitación semanal -->
                    <div class="dashboard-card">
                        <h4>Precipitación Semanal</h4>
                        <p class="chart-description">
                            <strong>¿Qué puedes ver aquí?</strong><br>
                            Este gráfico agrupa los datos diarios en semanas para mostrar patrones más amplios. 
                            Las barras doradas representan la precipitación total de cada semana. 
                            <strong>Barras altas</strong> indican semanas lluviosas, mientras que 
                            <strong>barras bajas</strong> sugieren semanas secas. 
                            Esto ayuda a identificar tendencias semanales y períodos de sequía prolongada.
                        </p>
                        <div class="chart-container">
                            <canvas id="weeklyChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Gráfico de tendencia -->
                    <div class="dashboard-card">
                        <h4>Tendencia de Precipitación</h4>
                        <p class="chart-description">
                            <strong>¿Qué puedes ver aquí?</strong><br>
                            Este gráfico muestra la tendencia general de la precipitación usando un promedio móvil de 7 días. 
                            La línea roja suaviza las variaciones diarias para revelar patrones a largo plazo. 
                            <strong>Línea ascendente</strong> indica aumento en la precipitación, mientras que 
                            <strong>línea descendente</strong> sugiere tendencia hacia la sequía. 
                            Es fundamental para predecir futuros patrones climáticos.
                        </p>
                        <div class="chart-container">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Función para mostrar loader
        function showLoader() {
            document.getElementById('loader').style.display = 'block';
            document.getElementById('outputContainer').style.display = 'none';
        }

        // Función para ocultar loader
        function hideLoader() {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('outputContainer').style.display = 'flex';
        }

        // Función para mostrar resultados
        function displayResults(data) {
            const results = document.getElementById('results');
            const analysisDetails = document.getElementById('analysisDetails');
            const methodsAnalysis = document.getElementById('methodsAnalysis');
            
            // Limpiar animaciones previas y añadir la nueva
            results.classList.remove('fade-in');
            analysisDetails.classList.remove('fade-in');

            // Mostrar resultados principales
                results.innerHTML = `
                <div class="state-info">
                    <strong>Estado Analizado: ${data.estado}</strong>
                </div>
                    <h3>Nivel de Riesgo: ${data.nivel}</h3>
                <div class="progress-bar">
                    <div class="progress-fill ${data.className.replace('risk-', 'progress-')}" 
                         style="width: ${(data.riesgo * 100)}%"></div>
                </div>
                    <p><strong>Probabilidad de Sequía:</strong> ${(data.riesgo * 100).toFixed(1)}%</p>
                    <p class="accion"><strong>Recomendación:</strong> ${data.accion}</p>
                `;
                
                // Aplicar clase de riesgo
                results.className = `results ${data.className}`;
                
            // Mostrar análisis detallado de métodos
            methodsAnalysis.innerHTML = `
                <div class="method-card">
                    <div class="method-title">Análisis de Tendencia (Cálculo Diferencial)</div>
                    <div class="prediction-value">${(data.riesgoTendencia * 100).toFixed(1)}%</div>
                    <p>Evalúa la tasa de cambio en la precipitación usando derivadas matemáticas.</p>
                </div>
                
                <div class="method-card">
                    <div class="method-title">Predicción Estadística (Regresión Lineal)</div>
                    <div class="prediction-value">${(data.prediccionEstadistica * 100).toFixed(1)}%</div>
                    <p>Utiliza regresión lineal simple basada en datos históricos.</p>
                </div>
                
                <div class="method-card">
                    <div class="method-title">Modelo Algebraico (Mínimos Cuadrados)</div>
                    <div class="prediction-value">${(data.prediccionAlgebra * 100).toFixed(1)}%</div>
                    <p>Aplica álgebra lineal y eliminación Gauss-Jordan para resolver ecuaciones normales.</p>
                </div>
                
            `;
            
            // Mostrar contenedores
                results.style.display = 'block';
                // Forzar un reflow para que la animación se reinicie
                void results.offsetWidth; 
                results.classList.add('fade-in');

            analysisDetails.style.display = 'block';
                void analysisDetails.offsetWidth;
                analysisDetails.classList.add('fade-in');
        }
                
        // Función para mostrar errores
        function displayError(error) {
            const results = document.getElementById('results');
                results.innerHTML = `
                <h3>Error en el Análisis</h3>
                    <p>No se pudo obtener el análisis de riesgo. Por favor, intente nuevamente.</p>
                    <p><strong>Error:</strong> ${error.message}</p>
                `;
                results.className = 'results risk-high';
                results.classList.remove('fade-in');
                void results.offsetWidth;
                results.classList.add('fade-in');
                results.style.display = 'block';
        }

        // Variables globales para los gráficos
        let dailyChart = null;
        let weeklyChart = null;
        let trendChart = null;
        let currentEstado = 'Chihuahua';

        // Función para crear gráfico de precipitación diaria
        function createDailyChart(data) {
            const ctx = document.getElementById('dailyChart').getContext('2d');
            
            if (dailyChart) {
                dailyChart.destroy();
            }
            
            const labels = data.map(item => {
                const date = new Date(item.fecha);
                return date.toLocaleDateString('es-MX', { month: 'short', day: 'numeric' });
            });
            
            dailyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Precipitación (mm)',
                        data: data.map(item => item.precipitacion),
                        backgroundColor: 'rgba(159, 34, 65, 0.8)',
                        borderColor: '#9F2241',
                        borderWidth: 1,
                        borderRadius: 4,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Precipitación (mm)',
                                color: '#d0d0d0' // Color de texto claro
                            },
                            ticks: { color: '#d0d0d0' }, // Color de los números del eje
                            grid: { color: 'rgba(255, 255, 255, 0.1)' } // Color de la cuadrícula
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Fecha'
                            },
                            ticks: { color: '#d0d0d0' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#e0e0e0' // Color del texto de la leyenda
                            }
                        }
                    }
                }
            });
        }

        // Función para crear gráfico de precipitación semanal
        function createWeeklyChart(data) {
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            
            if (weeklyChart) {
                weeklyChart.destroy();
            }
            
            const labels = data.map(item => {
                const date = new Date(item.fecha);
                return `Semana ${data.indexOf(item) + 1}`;
            });
            
            weeklyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Precipitación Semanal (mm)',
                        data: data.map(item => item.precipitacion),
                        backgroundColor: 'rgba(188, 149, 92, 0.8)',
                        borderColor: '#BC955C',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Precipitación (mm)',
                                color: '#d0d0d0'
                            },
                            ticks: { color: '#d0d0d0' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Semanas',
                                color: '#d0d0d0'
                            },
                            ticks: { color: '#d0d0d0' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#e0e0e0'
                            }
                        }
                    }
                }
            });
        }

        // Función para crear gráfico de tendencia
        function createTrendChart(data) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            if (trendChart) {
                trendChart.destroy();
            }
            
            // Calcular promedio móvil de 7 días
            const movingAverage = [];
            for (let i = 6; i < data.length; i++) {
                const avg = data.slice(i-6, i+1).reduce((sum, item) => sum + item.precipitacion, 0) / 7;
                movingAverage.push(avg);
            }
            
            const labels = data.slice(6).map(item => {
                const date = new Date(item.fecha);
                return date.toLocaleDateString('es-MX', { month: 'short', day: 'numeric' });
            });
            
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Promedio Móvil 7 días',
                        data: movingAverage,
                        borderColor: '#9F2241',
                        backgroundColor: 'rgba(159, 34, 65, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Precipitación Promedio (mm)',
                                color: '#d0d0d0'
                            },
                            ticks: { color: '#d0d0d0' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Fecha',
                                color: '#d0d0d0'
                            },
                            ticks: { color: '#d0d0d0' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#e0e0e0'
                            }
                        }
                    }
                }
            });
        }

        // Función para mostrar estadísticas
        function displayStats(stats) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${stats.precipitacion_total.toFixed(1)}</div>
                    <div class="stat-label">Total (mm)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${stats.precipitacion_promedio.toFixed(1)}</div>
                    <div class="stat-label">Promedio Diario</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${stats.precipitacion_maxima.toFixed(1)}</div>
                    <div class="stat-label">Máximo Diario</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${stats.dias_sin_lluvia}</div>
                    <div class="stat-label">Días Sin Lluvia</div>
                </div>
            `;
        }

        // Función para cargar datos del dashboard
        async function loadDashboardData(estado) {
            try {
                console.log(`Cargando datos del dashboard para: ${estado}`);
                const response = await fetch(`/api/dashboard/${encodeURIComponent(estado)}`);
                
                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Datos del dashboard:', data);
                
                if (data.error) {
                    throw new Error(data.message);
                }
                
                // Mostrar estadísticas
                displayStats(data.estadisticas);
                
                // Crear gráficos
                createDailyChart(data.datos_diarios);
                createWeeklyChart(data.datos_semanales);
                createTrendChart(data.datos_diarios);
                
            } catch (error) {
                console.error('Error cargando dashboard:', error);
                alert('Error al cargar los datos del dashboard: ' + error.message);
            }
        }

        // Event listener para el botón del dashboard
        document.getElementById('dashboardToggle').addEventListener('click', function() {
            const dashboardSection = document.getElementById('dashboardSection');
            if (dashboardSection.style.display === 'none') {
                dashboardSection.style.display = 'block';
                loadDashboardData(currentEstado);
            } else {
                dashboardSection.style.display = 'none';
            }
        });

        // Análisis automático
        document.getElementById('autoAnalysisBtn').addEventListener('click', async function() {
            showLoader();
            
            try {
                const estadoSeleccionado = document.getElementById('estadoSelect').value;
                currentEstado = estadoSeleccionado;
                console.log(`Iniciando análisis automático para: ${estadoSeleccionado}`);
                
                const response = await fetch(`/api/analizar?estado=${encodeURIComponent(estadoSeleccionado)}`);
                
                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Datos recibidos:', data);
                
                if (data.error) {
                    throw new Error(data.message);
                }
                
                hideLoader();
                displayResults(data);
                
                // Ocultar dashboard si estaba abierto
                document.getElementById('dashboardSection').style.display = 'none';
                
            } catch (error) {
                console.error('Error en análisis:', error);
                hideLoader();
                displayError(error);
            }
        });
    </script>
</body>
</html>
